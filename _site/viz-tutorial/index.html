<!DOCTYPE html>
<html>
  <head>
    <title>A simple tutorial for visualization of large, high-dimensional data – Jared Lorince – Cognitive Data Scientist</title>

        <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="I recently showed some examples of using Datashader for large scale visualization (post here), and the examples seemed to catch people’s attention at a workshop I attended earlier this week (Web of Science as a Research Dataset). Based on that interest, I’ve decided write up a little tutorial here to share with people. Hope it’s useful!

" />
    <meta property="og:description" content="I recently showed some examples of using Datashader for large scale visualization (post here), and the examples seemed to catch people’s attention at a workshop I attended earlier this week (Web of Science as a Research Dataset). Based on that interest, I’ve decided write up a little tutorial here to share with people. Hope it’s useful!

" />
    
    <meta name="author" content="Jared Lorince" />

    
    <meta property="og:title" content="A simple tutorial for visualization of large, high-dimensional data" />
    <meta property="twitter:title" content="A simple tutorial for visualization of large, high-dimensional data" />
    

    <!--[if lt IE 9]>
      <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <link rel="stylesheet" type="text/css" href="/style.css" />
    <link rel="alternate" type="application/rss+xml" title="Jared Lorince - Cognitive Data Scientist" href="/feed.xml" />

    <!-- Created with Jekyll Now - http://github.com/barryclark/jekyll-now -->
  </head>

  <body>
    <div class="wrapper-masthead">
      <div class="container">
        <header class="masthead clearfix">
          <!--<a href="/" class="site-avatar"><img src="" /></a>-->

          <div class="site-info">
            <h1 class="site-name"><a href="/">Jared Lorince</a></h1>
            <p class="site-description">Cognitive Data Scientist</p>
          </div>



          <nav>
          <style>
          .navlink[this=A simple tutorial for visualization of large, high-dimensional data] {
            font-weight: bold;
            }
          </style>
            <a href="/" class='navlink' this="blog">blog</a>
            <a href="/about" class='navlink' this="about">about</a>
            <a href="/research" class='navlink' this="research">research</a>
            <a href="/cv" class='navlink' this="cv" >cv</a>
            <!--<a href="/about">publications and presentations</a>-->
          </nav>
        </header>
      </div>
    </div>

    <div id="main" role="main" class="container">
      <article class="post">
  <h1>A simple tutorial for visualization of large, high-dimensional data</h1>

  <div class="entry">
    <p>I recently showed some examples of using <a href="https://datashader.readthedocs.io/en/latest/">Datashader</a> for large scale visualization (post <a href="https://jlorince.github.io/datashader/">here</a>), and the examples seemed to catch people’s attention at a workshop I attended earlier this week (<a href="http://cns.iu.edu/workshops/event/161114.html">Web of Science as a Research Dataset</a>). Based on that interest, I’ve decided write up a little tutorial here to share with people. Hope it’s useful!</p>

<p>So, the overall goal here is to take a big text dataset where each document is represented by a high-dimensional feature vector, and arrive at a meaningful 2D visualization of those points.</p>

<p>For the example here, I’m using the abstracts of 20M+ publications from the Web of Science (WoS has a total of 50-60M papers, but only abstracts for those published after ~1991) to generate a Doc2Vec model that represents each document (abstract) as a 200 dimensional feature vector. I then visualize a random sample of 5M of these papers using a tool called LargeVis (doing more is totally possible, but the system I ran this particular analysis on had “only” 48GB RAM, and attempting more than 5M documents was giving me memory errors). You can of course use a similar procedure with other ways of representing documents (e.g. LDA).</p>

<h3 id="step-1-generate-feature-vectors">Step 1: Generate feature vectors</h3>

<p>The particulars of the preprocessing I do here are unique to my data format, and to the fact that I’m using Gensim’s implementaion of Doc2Vec, so I won’t go into too much detail. The important thing (again assuming you’re using Doc2Vec) is that you simply generate a single text file with one document per line. Don’t forget to save some sort of index file so you know which line in your document file corresponds to which original document (we’ll need that later when we want to enrich our visualization with metadata from the original documents).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">gensim.models.doc2vec</span> <span class="kn">import</span> <span class="n">Doc2Vec</span><span class="p">,</span><span class="n">TaggedLineDocument</span>
<span class="kn">import</span> <span class="nn">gzip</span><span class="o">,</span><span class="nn">os</span><span class="o">,</span><span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="n">abs_dir</span> <span class="o">=</span> <span class="s">'/path/to/directory/with/abstracts'</span>

<span class="c"># This just does some basic text clearning to separate all the words from any surrounding punctuation, </span>
<span class="k">def</span> <span class="nf">normalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">):</span>
    <span class="n">norm_text</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

    <span class="c"># Replace breaks with spaces </span>
    <span class="n">norm_text</span> <span class="o">=</span> <span class="n">norm_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'|'</span><span class="p">,</span> <span class="s">' '</span><span class="p">)</span>

    <span class="c"># Pad punctuation with spaces on both sides</span>
    <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="p">[</span><span class="s">'.'</span><span class="p">,</span> <span class="s">'"'</span><span class="p">,</span> <span class="s">','</span><span class="p">,</span> <span class="s">'('</span><span class="p">,</span> <span class="s">')'</span><span class="p">,</span> <span class="s">'!'</span><span class="p">,</span> <span class="s">'?'</span><span class="p">,</span> <span class="s">';'</span><span class="p">,</span> <span class="s">':'</span><span class="p">]:</span>
        <span class="n">norm_text</span> <span class="o">=</span> <span class="n">norm_text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">char</span><span class="p">,</span> <span class="s">' '</span> <span class="o">+</span> <span class="n">char</span> <span class="o">+</span> <span class="s">' '</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">norm_text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">preprocess_docs</span><span class="p">(</span><span class="n">in_dir</span><span class="p">,</span><span class="n">out_dir</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">in_dir</span><span class="o">+</span><span class="s">'uid_indices.txt.gz'</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">idx_out</span><span class="p">,</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">out_dir</span><span class="o">+</span><span class="s">'docs.txt.gz'</span><span class="p">,</span><span class="s">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">docs</span><span class="p">:</span>
        <span class="n">overall_total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s">'{}/*.txt.gz'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">in_dir</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">'docs'</span> <span class="ow">or</span> <span class="s">'uid_indices'</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">print</span> <span class="s">"Starting file {}"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">)):</span>
                <span class="n">uid</span><span class="p">,</span><span class="n">text</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">docs</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">normalize_text</span><span class="p">(</span><span class="n">text</span><span class="p">)</span><span class="o">+</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
                <span class="n">idx_out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">uid</span><span class="o">+</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
            <span class="n">total</span> <span class="o">=</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">overall_total</span> <span class="o">+=</span> <span class="n">total</span>
            <span class="k">print</span> <span class="s">"{} complete: {} total documents ({} overall)"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">,</span><span class="n">total</span><span class="p">,</span><span class="n">overall_total</span><span class="p">)</span>


<span class="n">preprocess_docs</span><span class="p">(</span><span class="n">abs_dir</span><span class="p">,</span><span class="n">abs_dir</span><span class="p">)</span>

</code></pre>
</div>

<p>Now we run the actual Doc2Vec Model and save the results, which is all pretty straightforward. I’m using pretty standard parameters for Doc2Vec here, but there are good resources out there on parameter tuning if you’re curious..</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Generate a list of tagged line documents, one per line from the file generated above</span>
<span class="n">documents</span> <span class="o">=</span> <span class="p">[</span><span class="n">doc</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">TaggedLineDocument</span><span class="p">(</span><span class="n">abs_dir</span><span class="o">+</span><span class="s">'docs.txt.gz'</span><span class="p">)]</span>

<span class="c"># Now just run the model. A simple little one-liner. Be sure to take advantages of the the `workers` option, which parallelizes the model automagically</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">Doc2Vec</span><span class="p">(</span><span class="n">documents</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">window</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">min_count</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">workers</span><span class="o">=</span><span class="mi">24</span><span class="p">)</span>

<span class="c"># the resulting feature vectors are stored in `model.docvecs.doctag_syn0`, so let's just save that numpy array</span>
<span class="n">np</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">abs_dir</span><span class="o">+</span><span class="s">'features-w2v-200.npy'</span><span class="p">,</span><span class="n">model</span><span class="o">.</span><span class="n">docvecs</span><span class="o">.</span><span class="n">doctag_syn0</span><span class="p">)</span>

<span class="c"># this is only really necessary if we're using t-sne for visualization (which is more well-known, but does not scale very nicely to really big datasets), as LargeVis automatically normalizes</span>
<span class="s">"""
from sklearn.preprocessing import Normalizer
nrm = Normalizer('l2')
normed = nrm.fit_transform(model.docvecs.doctag_syn0)
np.save(abs_dir+'features_normed-w2v-200.npy',normed)
"""</span>

</code></pre>
</div>

<h3 id="step-2--generate-our-2d-embedding">Step 2:  Generate our 2D embedding</h3>

<p>Both <a href="https://github.com/lvdmaaten/bhtsne">t-SNE</a> and <a href="https://github.com/lferry007/LargeVis">LargeVis</a> have particular data formats they require, which are quite simple. T-SNE’s python wrapper is actually easy to modify so that it reads the numpy array we generated above directly, but in any case I’m going to focus on using LargeVis in the standard way (though you could probably get it to work on numpy arrays directly if needed). This all assumes you’ve compiled and installed LargeVis following the instructions on their <a href="https://github.com/lferry007/LargeVis">Github repo</a>.</p>

<p>I typically just run LargeVis from the command line, but here I adapt <a href="https://github.com/lferry007/LargeVis">this script</a> to run it in the notebook (with default parameters…see the <a href="https://arxiv.org/abs/1602.00370">LargeVis paper</a> for details on tuning these).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># load features</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">abs_dir</span><span class="o">+</span><span class="s">'features-w2v-200.npy'</span><span class="p">)</span>

<span class="c"># for this example we're randomly sampling 5M of them, so here I sample and save the random indices of the sample</span>
<span class="n">random_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="nb">xrange</span><span class="p">(</span><span class="mi">5000000</span><span class="p">),</span><span class="n">replace</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'indices_5M'</span><span class="p">,</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">','</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random_indices</span><span class="o">.</span><span class="n">asype</span><span class="p">(</span><span class="nb">str</span><span class="p">)))</span>
<span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">[</span><span class="n">random_indices</span><span class="p">]</span>

<span class="c"># now we write the data to file in the required LargeVis format (which requires a header with the number of items and the dimensionality of the feature vectors)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s">'lv_format.txt'</span><span class="p">,</span><span class="s">'w'</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">"{}</span><span class="se">\t</span><span class="s">{}</span><span class="se">\n</span><span class="s">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">features</span><span class="o">.</span><span class="n">shape</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">'</span><span class="se">\t</span><span class="s">'</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">))</span><span class="o">+</span><span class="s">'</span><span class="se">\n</span><span class="s">'</span><span class="p">)</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># now run Large Vis!</span>
<span class="kn">import</span> <span class="nn">LargeVis</span>

<span class="c"># LargeVis doesn't take named arguments, so we have to pass all these explicitly, using -1 to indicate defaults </span>
<span class="c"># (this is handled more smoothly by argparse when calling from command line)</span>

<span class="n">outdim</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">threads</span> <span class="o">=</span> <span class="mi">24</span>
<span class="n">samples</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">prop</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">trees</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">neg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">neigh</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="n">perp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="n">LargeVis</span><span class="o">.</span><span class="n">loadfile</span><span class="p">(</span><span class="s">"lv_format.txt"</span><span class="p">)</span>

<span class="n">Y</span> <span class="o">=</span> <span class="n">LargeVis</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">outdim</span><span class="p">,</span> <span class="n">threads</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">prop</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">trees</span><span class="p">,</span> <span class="n">neg</span><span class="p">,</span> <span class="n">neigh</span><span class="p">,</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">perp</span><span class="p">)</span>

<span class="n">LargeVis</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="s">"lv_output.txt"</span><span class="p">)</span>
</code></pre>
</div>

<p>Now we have out 2D embedding!</p>

<h3 id="step-3-visualization">Step 3: Visualization</h3>

<p>Now let’s walk through an example visualization pipeline. There are of course plenty of different things you could do here, but this example will hopefully give you the basics. We’ll start with some preliminary imports, and define a little legend function we’ll use below.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">graphlab</span> <span class="kn">as</span> <span class="nn">gl</span>
<span class="kn">from</span> <span class="nn">seaborn</span> <span class="kn">import</span> <span class="n">color_palette</span><span class="p">,</span><span class="n">palplot</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">display</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="kn">as</span> <span class="nn">mpl</span>
<span class="o">%</span><span class="n">matplotlib</span> <span class="n">inline</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># Just a clunky little function to generate a legend (given color pallette and labels) as</span>
<span class="c"># an independent matplotlib figure</span>
<span class="k">def</span> <span class="nf">keyplot</span><span class="p">(</span><span class="n">pal</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">pal</span><span class="p">)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="n">n</span><span class="o">%</span><span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">rows</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="n">f</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="o">*</span><span class="n">rows</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rows</span> <span class="o">==</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">axes</span><span class="p">,]</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span><span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">axes</span><span class="p">):</span>
        <span class="n">current_pal</span> <span class="o">=</span> <span class="n">pal</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">5</span><span class="p">:(</span><span class="n">idx</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">current_pal</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">5</span><span class="p">:</span>
            
            <span class="n">current_pal</span> <span class="o">+=</span> <span class="p">[</span><span class="s">'white'</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">5</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">current_pal</span><span class="p">))</span>
        <span class="n">current_names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[</span><span class="n">idx</span><span class="o">*</span><span class="mi">5</span><span class="p">:(</span><span class="n">idx</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>
                  <span class="n">cmap</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">ListedColormap</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">current_pal</span><span class="p">)),</span>
                  <span class="n">interpolation</span><span class="o">=</span><span class="s">"nearest"</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s">"auto"</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="o">-.</span><span class="mi">5</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">current_names</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">name</span><span class="p">,(</span><span class="o">-.</span><span class="mi">45</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="mf">0.1</span><span class="p">))</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([])</span>

<span class="c"># Example:</span>
<span class="n">keyplot</span><span class="p">(</span><span class="n">color_palette</span><span class="p">(</span><span class="s">'Set1'</span><span class="p">,</span><span class="mi">9</span><span class="p">),</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'Blah'</span><span class="p">]</span><span class="o">*</span><span class="mi">9</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="../images/post_20161116/output_14_0.png" alt="png" /></p>

<p>Now, let’s load our learned embedding indices of our random sample of documents into a Pandas dataframe:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># be sure to skip the header row that LargeVis generates</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_table</span><span class="p">(</span><span class="s">'wos_lv_output_5M.txt'</span><span class="p">,</span><span class="n">header</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">skiprows</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">],</span><span class="n">delimiter</span><span class="o">=</span><span class="s">' '</span><span class="p">)</span>

<span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s">'indices_5M'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">','</span><span class="p">),</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s">'idx'</span><span class="p">]</span> <span class="o">=</span> <span class="n">indices</span>
</code></pre>
</div>

<p>Now, for my case I have some Graphlab sframes in which I’ve previously stored a bunch of metadata on the abstracts we’re modeling. Your data will surely be different (and the use of Graphlab here is totally incidental), but the gist of what I’m doing here is joining the xy coordinates from the LargeVis 2D embedding with the metadata.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">uids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">gzip</span><span class="o">.</span><span class="nb">open</span><span class="p">(</span><span class="s">'/path/to/uid_indices.txt.gz'</span><span class="p">)</span><span class="o">.</span><span class="n">readlines</span><span class="p">()])</span>
<span class="n">uid_indices</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">SFrame</span><span class="p">({</span><span class="s">'uid'</span><span class="p">:</span><span class="n">uids</span><span class="p">[</span><span class="n">indices</span><span class="p">],</span><span class="s">'idx'</span><span class="p">:</span><span class="n">indices</span><span class="p">})</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">metadata</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">SFrame</span><span class="p">(</span><span class="s">'P:/Projects/WoS/WoS/parsed/metadata.sframe/'</span><span class="p">)</span>
<span class="n">cats</span> <span class="o">=</span> <span class="n">gl</span><span class="o">.</span><span class="n">SFrame</span><span class="p">(</span><span class="s">'P:/Projects/WoS/WoS/parsed/categories.sframe'</span><span class="p">)</span>
<span class="n">joined</span> <span class="o">=</span> <span class="n">metadata</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">uid_indices</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s">'uid'</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s">'inner'</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cats</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s">'uid'</span><span class="p">,</span><span class="n">how</span><span class="o">=</span><span class="s">'inner'</span><span class="p">)</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
</code></pre>
</div>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">plot_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">joined</span><span class="p">,</span><span class="n">on</span><span class="o">=</span><span class="s">'idx'</span><span class="p">)</span>
</code></pre>
</div>

<p>However you get there, waht you want is a pandas dataframe with one row per document, with the xy coordinates and whatever metadata you care about using to enrich your visualization. (Datashader, which we’ll be using below, also works nicely with out-of-core Dask dataframes, so don’t feel like you’re limited to data structures that fit in memory!). For the purposes of this example, the only metadata I care about is the WoS subheading for each paper, and the WoS-assigned subject categories.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">plot_data</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[[</span><span class="s">'x'</span><span class="p">,</span><span class="s">'y'</span><span class="p">,</span><span class="s">'subheading'</span><span class="p">,</span><span class="s">'categories'</span><span class="p">]]</span>
<span class="n">plot_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</code></pre>
</div>
<p>[ EDIT: I know this table formatting is messed up, but haven’t figured out how to fix it! ]</p>

<div>
<table border="1" class="dataframe">
<thead>
<tr style="text-align: right;">
<th></th>
<th>x</th>
<th>y</th>
<th>subheading</th>
<th>categories</th>
</tr>
</thead>
<tbody>
<tr>
<th>0</th>
<td>-0.947329</td>
<td>-3.782668</td>
<td>Life Sciences &amp; Biomedicine</td>
<td>Pharmacology &amp; Pharmacy</td>
</tr>
<tr>
<th>1</th>
<td>-6.668430</td>
<td>7.766551</td>
<td>Life Sciences &amp; Biomedicine</td>
<td>Biology|Mathematical &amp; Computational Biology</td>
</tr>
<tr>
<th>2</th>
<td>-16.014929</td>
<td>14.479502</td>
<td>Physical Sciences</td>
<td>Mathematics</td>
</tr>
<tr>
<th>3</th>
<td>10.640243</td>
<td>-16.039352</td>
<td>Life Sciences &amp; Biomedicine</td>
<td>Oncology|Radiology, Nuclear Medicine &amp; Medical...</td>
</tr>
<tr>
<th>4</th>
<td>-21.193598</td>
<td>0.940371</td>
<td></td>
<td>Criminology &amp; Penology</td>
</tr>
</tbody>
</table>
</div>

<p>Now, datashader requires that we explicitly represent categorical data as categorical data types, so let’s do that</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">plot_data</span><span class="p">[</span><span class="s">'subheading'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s">'subheading'</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
</code></pre>
</div>

<p>Let’s also simplfify the category data by just looking as the first category assigned to each paper. We <em>won’t</em> convert to categorical data yet, as we need to do some other preprocessing of the category data below first.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">plot_data</span><span class="p">[</span><span class="s">'top_cat'</span><span class="p">]</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="s">'categories'</span><span class="p">]</span><span class="o">.</span><span class="nb">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">'|'</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

</code></pre>
</div>

<p>Now we’re (almost) ready to actually generate some visuals! There’s a bit of boilerplate we’ll want to start with for datashader. MOst of is adapted from <a href="https://anaconda.org/jbednar/census/notebook">this tutorial</a>.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># this is critical. Datashader depends on defining an image of a specified size in pixels</span>
<span class="n">plot_width</span>  <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="n">plot_height</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
<span class="n">background</span> <span class="o">=</span> <span class="s">"black"</span>

<span class="kn">import</span> <span class="nn">datashader</span> <span class="kn">as</span> <span class="nn">ds</span>
<span class="kn">import</span> <span class="nn">datashader.transfer_functions</span> <span class="kn">as</span> <span class="nn">tf</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">datashader.utils</span> <span class="kn">import</span> <span class="n">export_image</span>
<span class="kn">from</span> <span class="nn">datashader.colors</span> <span class="kn">import</span> <span class="n">colormap_select</span><span class="p">,</span> <span class="n">Greys9</span><span class="p">,</span> <span class="n">Hot</span><span class="p">,</span> <span class="n">viridis</span><span class="p">,</span> <span class="n">inferno</span>
<span class="kn">from</span> <span class="nn">IPython.core.display</span> <span class="kn">import</span> <span class="n">HTML</span><span class="p">,</span> <span class="n">display</span>

<span class="c"># this function actually generates the datashader image </span>
<span class="n">export</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">export_image</span><span class="p">,</span> <span class="n">background</span> <span class="o">=</span> <span class="n">background</span><span class="p">,</span> <span class="n">export_path</span><span class="o">=</span><span class="s">"export"</span><span class="p">)</span>

<span class="c"># this handles colorinzing of the image</span>
<span class="n">cm</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">colormap_select</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="p">(</span><span class="n">background</span><span class="o">!=</span><span class="s">"black"</span><span class="p">))</span>
</code></pre>
</div>

<p>Now we can make an image with datashader. In the words of datashaders’s readme:<br />
&gt; Datashader is a graphics pipeline system for creating meaningful representations of large amounts of data. It breaks the creation of images into 3 main steps: <br />
1. Projection: Each record is projected into zero or more bins, based on a specified glyph.<br />
2. Aggregation: Reductions are computed for each bin, compressing the potentially large dataset into a much smaller aggregate.<br />
3. Transformation: These aggregates are then further processed to create an image.</p>

<p>In terms of code, that requires that we (1) define a canvas, (2) define our (aggregated) glyphs, and (3) define the transformation function that turns the aggreagation into an image. Note that I’m just saving all my images as “tempfile” since I’m just working in the notebook anyway.</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># define canvas of a specified dimension</span>
<span class="n">cvs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">plot_width</span><span class="p">,</span> <span class="n">plot_height</span><span class="p">)</span>
<span class="c"># aggregate *point* data into bins specified by the size of our image</span>
<span class="c"># this amounts to defining a value for each *pixel* in the image</span>
<span class="n">agg</span> <span class="o">=</span> <span class="n">cvs</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">plot_data</span><span class="p">,</span> <span class="s">'x'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">)</span>
<span class="c"># now use a transfer function to draw the image. In this case we shade each pixel </span>
<span class="c"># based on the number of of observations falling within each pixel</span>
<span class="n">export</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="p">(</span><span class="n">Greys9</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s">'linear'</span><span class="p">),</span><span class="s">'tempfile'</span><span class="p">)</span>

</code></pre>
</div>

<p><img src="../images/post_20161116/output_30_0.png" alt="png" /></p>

<p>Pretty neat (and as you’ll see when you try running it, <em>fast</em> too). But because the point density is pretty low for any given pixel, the structure is hard to see. We can fix this by using a non-linear shading scheme, like eq_hist (logarithmic shading is also an option). From the tutorial linked above:<br />
&gt; …let’s try the image-processing technique called histogram equalization. I.e., given a set of raw counts, map these into a range for display such that every available color on the screen represents about the same number of samples in the original dataset. The result is similar to that from the log transform, but is now non-parametric – it will equalize any linearly or nonlinearly distributed integer data, regardless of the distribution:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">export</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="p">(</span><span class="n">Greys9</span><span class="p">),</span> <span class="n">how</span><span class="o">=</span><span class="s">'eq_hist'</span><span class="p">),</span><span class="s">'tempfile'</span><span class="p">)</span>

</code></pre>
</div>

<p><img src="../images/post_20161116/output_32_0.png" alt="png" /></p>

<p>Ok, that looks better, and we have some nice structure. But of course we don’t know yet if this is just a pretty picture, or actually captures something meaningful about our data. Now let’s look at some methods for incorporating metadata that will help resolve this.</p>

<p>To accomplish, we’re going to define a more sophisticated plotting function that will colorize points based on either (a) the WoS subheading, or (b) the top category for each paper. In the latter case, there are more categories than distinguishable colors, so we’ll design the function to only draw the top N most popular categoeries (for the example I’ll use 9, which is about the max number of colors I’ve found that is easy to distinguish).</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="c"># `cat` specifies which categorical column we want to color by, and topN limits plotting to the top N most common categories in that column</span>
<span class="k">def</span> <span class="nf">create_image</span><span class="p">(</span><span class="n">w</span><span class="o">=</span><span class="n">plot_width</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">plot_height</span><span class="p">,</span><span class="n">cat</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">color_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">topN</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="c"># if we specify a `topN`, determined which are the top N most commmon categories, and limit the dataframe to the corresponding rows</span>
    <span class="k">if</span> <span class="n">topN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">topN</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[:</span><span class="n">topN</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">topN</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">plot_data</span>
    <span class="c"># now that we've done our sampling we can convert the column to a category type</span>
    <span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
    <span class="c"># unless we explicitly pass a {category:color} dictionary, generate the color map</span>
    <span class="k">if</span> <span class="n">color_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="c"># this is s kludge to handle the fact that some plotting libraries don't handle seaborn color paletes well (just converting to hex color names)</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s">'#</span><span class="si">%02</span><span class="s">x</span><span class="si">%02</span><span class="s">x</span><span class="si">%02</span><span class="s">x'</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color_palette</span><span class="p">(</span><span class="s">'Set1'</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">))))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="c"># use matplotlib to draw a legend</span>
        <span class="n">keyplot</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span><span class="n">unique_values</span><span class="p">)</span>
        <span class="n">color_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span><span class="n">color</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_values</span><span class="p">,</span><span class="n">colors</span><span class="p">)}</span>    
        
    <span class="c"># now the plotting command is the sameas above, except we use a `color_key` arugment to tell datashader how to color each point</span>
    <span class="n">cvs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">plot_width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    <span class="n">agg</span> <span class="o">=</span> <span class="n">cvs</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s">'x'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">count_cat</span><span class="p">(</span><span class="n">cat</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">color_key</span><span class="o">=</span><span class="n">color_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'eq_hist'</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">img</span>
</code></pre>
</div>

<p>So let’s run this code, colorizing by WoS subheading:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">export</span><span class="p">(</span><span class="n">create_image</span><span class="p">(</span><span class="n">cat</span><span class="o">=</span><span class="s">'subheading'</span><span class="p">),</span><span class="s">'tempfile'</span><span class="p">)</span>
</code></pre>
</div>

<p><img src="../images/post_20161116/output_36_0.png" alt="png" /></p>

<p><img src="../images/post_20161116/output_36_1.png" alt="png" /></p>

<p>There we go! While it’s not perfect, we can clearly see that papers that cluster together in the Doc2Vec feature space also tend to be within the same broad category according to WoS (note that blue is blank because it corresponds to the social sciences and humanities top level WoS heading, for which there are no subheadings). To see the organization at a finer granularity, let’s do the same thing, but colored by the top 9 most common subject categories:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="n">export</span><span class="p">(</span><span class="n">create_image</span><span class="p">(</span><span class="n">cat</span><span class="o">=</span><span class="s">'top_cat'</span><span class="p">,</span><span class="n">topN</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span><span class="s">'tempfile'</span><span class="p">)</span>

</code></pre>
</div>

<p><img src="../images/post_20161116/output_38_0.png" alt="png" /></p>

<p><img src="../images/post_20161116/output_38_1.png" alt="png" /></p>

<p>While it’s not quite as clean, and of course sparser (because we’re looking at a much smaller subset of papers), we can again see an impressive level of coherent organization, even though we had to go through a lot of preprocessing steps to get here.</p>

<h3 id="going-further">Going further…</h3>

<p>To wrap up, I want to close with some further ideas on cool directions to go with datashader visualization. First off, for those you who are used to working with Matplotlib (like me!) datashader is undoubtedly awesome, but doesn’t make it easy to do seemingly basic things like annotation, axis labels, etc. Luckily there is a workaround. Because datashader generates rasterized images, it’s actually pretty straightforward to import pull them into a matplotlib figure with <code class="highlighter-rouge">imread</code> and <code class="highlighter-rouge">imshow</code>, and then layer traditional matplotlib visual elements on top of them, like so:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">scipy.misc</span> <span class="kn">import</span> <span class="n">imread</span>

<span class="c"># standard matplotlib figure creation</span>
<span class="n">fig</span><span class="p">,</span><span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="c"># load our saved image, and make it the backgroudn of our figured (with a slighly reduced alpha)</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">imread</span><span class="p">(</span><span class="s">'export/tempfile.png'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">alpha</span><span class="o">=.</span><span class="mi">75</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([]);</span>

</code></pre>
</div>

<p><img src="../images/post_20161116/output_41_0.png" alt="png" /></p>

<p>From here, you can add anything you want to the image using the matplotlib (or seaborn, or whatever, that you’re used to). Just be cautious about making to scale the matplotlib axis elements appropriately to your raster image. As a more practical example (from a differnt project) here’s a similarity matrix I generated for 10,000 musical artists from last.fm (so yes, datshader here is actually plotting 100 million datapoints, and it handles this scale of data with no problems whatsoever):</p>

<p><img src="../images/post_20161116/music_sim_2.png" alt="png" /></p>

<p>Using the same process as above, I imported my datashader png image into a matplotlib figure,defined custom tick labels and locations, and used <code class="highlighter-rouge">axhline</code> and <code class="highlighter-rouge">axvline</code> to annotate the image. Here artists are sorted by genre, and I label the regions of the image corresponding to each genre.</p>

<p>The last thing I’ll introduce (only briefly) is interactive plotting. Datshader actually interacts very nicely with Bokeh to genrate interactive plots. The results of this won’t display nicely in the browser, so for now I’ll just share the code and some screenshots.</p>

<p>The process is actually fairly simple, and requires that you first define a base Bokeh plot:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">bokeh.plotting</span> <span class="kn">as</span> <span class="nn">bp</span>
<span class="kn">from</span> <span class="nn">datashader.bokeh_ext</span> <span class="kn">import</span> <span class="n">InteractiveImage</span>

<span class="n">bp</span><span class="o">.</span><span class="n">output_notebook</span><span class="p">()</span>
<span class="n">x_range</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
<span class="n">y_range</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">24</span><span class="p">,</span><span class="mi">24</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">base_plot</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="s">'pan,wheel_zoom,reset,box_zoom'</span><span class="p">,</span><span class="n">webgl</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">bp</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">tools</span><span class="o">=</span><span class="n">tools</span><span class="p">,</span>
        <span class="n">plot_width</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
         <span class="n">outline_line_color</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span>
        <span class="n">min_border</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_border_left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_border_right</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">min_border_top</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">min_border_bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">webgl</span><span class="o">=</span><span class="n">webgl</span><span class="p">)</span>
    
    <span class="n">p</span><span class="o">.</span><span class="n">axis</span><span class="o">.</span><span class="n">visible</span> <span class="o">=</span> <span class="bp">False</span>
    <span class="n">p</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">p</span><span class="o">.</span><span class="n">ygrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">p</span><span class="o">.</span><span class="n">background_fill_color</span> <span class="o">=</span> <span class="s">"black"</span>
    
    <span class="k">return</span> <span class="n">p</span>
</code></pre>
</div>

<p>Next we define an image callback function (which is essentially the same as the image creation code we used before), and then generate the interactive image:</p>

<div class="highlighter-rouge"><pre class="highlight"><code><span class="k">def</span> <span class="nf">image_callback</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span><span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">,</span><span class="n">w</span><span class="o">=</span><span class="n">plot_width</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">plot_height</span><span class="p">,</span><span class="n">cat</span><span class="o">=</span><span class="s">'top_cat'</span><span class="p">,</span><span class="n">color_key</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span><span class="n">topN</span><span class="o">=</span><span class="mi">9</span><span class="p">):</span>
   
    <span class="k">if</span> <span class="n">topN</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">topN</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()[:</span><span class="n">topN</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">plot_data</span><span class="p">[</span><span class="n">plot_data</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">topN</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">plot_data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
       
    <span class="k">if</span> <span class="n">color_key</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">unique_values</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s">'#</span><span class="si">%02</span><span class="s">x</span><span class="si">%02</span><span class="s">x</span><span class="si">%02</span><span class="s">x'</span> <span class="o">%</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="nb">round</span><span class="p">(</span><span class="mi">255</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">color_palette</span><span class="p">(</span><span class="s">'Set1'</span><span class="p">,</span><span class="n">n_colors</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">unique_values</span><span class="p">))))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)]</span>
        <span class="n">keyplot</span><span class="p">(</span><span class="n">colors</span><span class="p">,</span><span class="n">unique_values</span><span class="p">)</span>
        <span class="n">color_key</span> <span class="o">=</span> <span class="p">{</span><span class="n">val</span><span class="p">:</span><span class="n">color</span> <span class="k">for</span> <span class="n">val</span><span class="p">,</span><span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">unique_values</span><span class="p">,</span><span class="n">colors</span><span class="p">)}</span>
    
    <span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">cat</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s">'category'</span><span class="p">)</span>
    
    <span class="n">cvs</span> <span class="o">=</span> <span class="n">ds</span><span class="o">.</span><span class="n">Canvas</span><span class="p">(</span><span class="n">plot_width</span><span class="o">=</span><span class="n">w</span><span class="p">,</span> <span class="n">plot_height</span><span class="o">=</span><span class="n">h</span><span class="p">,</span><span class="n">x_range</span><span class="o">=</span><span class="n">x_range</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="n">y_range</span><span class="p">)</span>
    <span class="n">agg</span> <span class="o">=</span> <span class="n">cvs</span><span class="o">.</span><span class="n">points</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="s">'x'</span><span class="p">,</span> <span class="s">'y'</span><span class="p">,</span> <span class="n">ds</span><span class="o">.</span><span class="n">count_cat</span><span class="p">(</span><span class="n">cat</span><span class="p">))</span>
    <span class="n">img</span> <span class="o">=</span> <span class="n">tf</span><span class="o">.</span><span class="n">shade</span><span class="p">(</span><span class="n">agg</span><span class="p">,</span> <span class="n">color_key</span><span class="o">=</span><span class="n">color_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s">'eq_hist'</span><span class="p">)</span>
    <span class="c"># dynspread just makes points expand a bit when you zoom in</span>
    <span class="k">return</span> <span class="n">tf</span><span class="o">.</span><span class="n">dynspread</span><span class="p">(</span><span class="n">img</span><span class="p">,</span><span class="n">threshold</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">max_px</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>

<span class="c"># commenting these out because they won't work on a static webpage</span>
<span class="c">#p = base_plot()</span>
<span class="c">#InteractiveImage(p, image_callback)</span>
</code></pre>
</div>

<p>Again, you’ll have to run this yourself to get the interactive version, but what you end up should look something like this (note the interaction controls in the corner):</p>

<p><img src="../images/post_20161116/screenshot1.png" alt="png" /></p>

<p>Where the real power of combining Datashader and Bokeh shows is when you zoom in:</p>

<p><img src="../images/post_20161116/screenshot2.png" alt="png" /></p>

<p>When you zoom, Datashader dynamically re-renders the visualizaion to increase the granulrity. It’s awesome to see in action, and I strongly recommend you look at the Datashader <a href="https://anaconda.org/jbednar/census/notebook">census tutorial</a> to see some exceptionally elegant illustrations of how data rendering at different zoom levels works.</p>

<p>Well, that’s all for now. Please feel free to reach out to jared.j.lorince (at) gmail (dot) com with any thoughts or questions! The notebook of this tutorial is available <a href="https://github.com/jlorince/fun-with-notebooks/blob/master/datashader-viz-tutorial/datashader-viz-tutorial.ipynb">here</a>, but unfortunately I am not able to share the raw data.</p>

  </div>

  <div class="date">
    2016-11-16
  </div>

  
</article>

    </div>

    <div class="wrapper-footer">
      <div class="container">
        <footer class="footer">
          
<a href="mailto:jared.j.lorince@gmail.com"><i class="svg-icon email"></i></a>


<a href="https://scholar.google.com/citations?user=2Yxrx8MAAAAJ&hl=en"><i class="svg-icon scholar"></i></a>
<a href="https://github.com/jlorince"><i class="svg-icon github"></i></a>

<a href="https://www.linkedin.com/in/jaredlorince"><i class="svg-icon linkedin"></i></a>


<a href="https://www.twitter.com/axelstreichen"><i class="svg-icon twitter"></i></a>



<a href="http://last.fm/user/AxelStreichen"><i class="svg-icon lastfm"></i></a>

        </footer>
      </div>
    </div>

    

  </body>
</html>
